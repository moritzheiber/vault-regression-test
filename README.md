# Vault Upgrade Regression Test

This is a simple regression test for an unusual behaviour I have observed when upgrading from Vault 0.6.2 to Vault 0.7.3.

With 0.6.2 generating an internal CA alongside a role for issuing a certificate and claiming such a certificate will result in a service being able to fetch all three components on such a certificate (certificate, private\_key, issuing\_ca). Alongside `consul-template` this means supplying an arbitrary service with a valid certificate without the fear of having it expire on you.

However, with all Vault versions beyond 0.7.0 `consul-template` will renew the certificate after exactly **2 minutes and 30 seconds**, no matter what the lifetime of the certificate ("`ttl`") or the `ttl` of the CA are. This also leads to the child process started with the `exec` directive being restarted on a regular basis (which is not the desired behaviour).

## Running the test

### Prerequisites

- Docker (>= 17.05.0-ce)
- docker-compose (>= 1.13.0)
- Terraform (>= 0.9.8)

### Running the test

Just issue:

```sh
./go run
```

This will bring up a Vault in `dev` mode, initialize a CA, create two roles and a token for the service, which is started afterwards. The service itself is using `consul-template` to fetch a certificate for whichever role is being used in the `config/certs.json.ctmpl` template.

Now let it run for more than 2 minutes and 30 seconds.

You can step through individual Vault versions by running:

```sh
VERSION=<vault-version> ./go run
# Example: VERSION=0.6.5 ./go run
```

### Expected behaviour

The child process run via the `exec` directive inside `consul-template` is kept on running without interruption.

### Observed behaviour (without `generate_lease` on Vault >= 0.7.0)

Templates are re-evaluated after roughly 2 minutes and 30 seconds, which in turn leads to the child being restart, indicated by the output on the terminal yielding different certificates (you might have to scroll up a little).

### Ending the test

Press CTRL-C to end the loop.

## Mitigation

It seems adding the directive `generate_lease` to the role associated with issuing the lease resolves this issue. I'm still unclear as to why that is though.

There are two roles being generated by default, `test_role` and `test_role_with_lease`. Change the role being used in the configuration (`config/certs.json.ctmpl`) accordingly to test two different behaviours simultaniously.

## Questions?

- Is this a bug in `consul-template` or Vault?
- What does `generate_lease` mean in this context?
- Why is it exactly 2m30s?
